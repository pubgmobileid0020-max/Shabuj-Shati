<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sobujsathi Pro | Intelligent Enterprise SaaS</title>
    
    <!-- Enterprise Grade Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --brand: #10b981; --primary: #0f172a; --slate-soft: #f8fafc; }
        body { 
            font-family: 'Plus Jakarta Sans', 'Hind Siliguri', sans-serif; 
            background-color: #f1f5f9; 
            color: var(--primary);
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
        }
        
        /* Glass UI Components */
        .glass-header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        .sidebar-item { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-active { background: #ecfdf5; color: var(--brand); border-right: 4px solid var(--brand); font-weight: 700; }
        
        .card-enterprise { 
            background: white; 
            border: 1px solid rgba(226, 232, 240, 0.6); 
            border-radius: 1.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
            transition: all 0.3s ease;
        }
        .card-enterprise:hover { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.06); transform: translateY(-4px); }

        .btn-brand { background: var(--brand); color: white; transition: all 0.2s ease; box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.2); }
        .btn-brand:active { transform: scale(0.96); }

        .ai-magic-box {
            background: radial-gradient(circle at top right, #1e293b, #0f172a);
            border: 1px solid rgba(16, 185, 129, 0.3);
            position: relative;
            overflow: hidden;
        }

        @keyframes viewSlide { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .animate-render { animation: viewSlide 0.4s ease-out forwards; }
        
        /* Grid Layouts */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        @media (min-width: 768px) { .product-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; } }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .mobile-stack tr { display: flex; flex-direction: column; padding: 1.25rem; background: white; margin-bottom: 1rem; border-radius: 1.5rem; border: 1px solid #e2e8f0; }
            .mobile-stack td { display: flex; justify-content: space-between; padding: 0.5rem 0; border: none !important; font-size: 0.9rem; }
            .mobile-stack thead { display: none; }
            .mobile-stack td::before { content: attr(data-label); font-weight: 700; color: #64748b; font-size: 0.75rem; text-transform: uppercase; }
            
            .pos-sheet { transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: fixed; bottom: 0; left: 0; right: 0; z-index: 100; height: 85vh; border-radius: 2.5rem 2.5rem 0 0; background: white; border-top: 1px solid #cbd5e1; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); }
            .pos-sheet.open { transform: translateY(0); }
        }

        .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="overflow-x-hidden selection:bg-emerald-100">

    <!-- Auth Module -->
    <div id="auth-screen" class="fixed inset-0 z-[1000] bg-white flex flex-col md:flex-row hidden">
        <div class="hidden md:flex md:w-5/12 bg-slate-950 p-16 flex flex-col justify-between text-white relative overflow-hidden text-left">
            <div class="relative z-10">
                <div id="auth-logo-pane" class="mb-12 scale-125 origin-left"></div>
                <h1 class="text-5xl font-black tracking-tighter leading-tight mb-4">Sobujsathi Pro<br>Enterprise ERP</h1>
                <p class="text-emerald-500 opacity-90 text-lg max-w-sm font-medium">‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶è‡¶¨‡¶Ç AI ‡¶ö‡¶æ‡¶≤‡¶ø‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶≠‡ßÅ‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶®‡•§</p>
            </div>
            <div class="absolute -bottom-20 -right-20 w-96 h-96 bg-emerald-500/10 rounded-full blur-[120px]"></div>
        </div>
        <div class="flex-1 bg-slate-50 flex items-center justify-center p-6 md:p-12">
            <div class="w-full max-w-md animate-render">
                <div class="text-center md:text-left mb-12">
                    <div id="auth-logo-mobile" class="md:hidden flex justify-center mb-8"></div>
                    <h2 id="auth-title" class="text-4xl font-black text-slate-900 tracking-tight leading-none mb-2">Workspace Access</h2>
                    <p id="auth-subtitle" class="text-slate-500 font-medium tracking-tight">Enterprise Identity verification required.</p>
                </div>
                <form id="auth-form" class="space-y-4">
                    <div class="space-y-1.5 text-left font-sans"><label class="text-[10px] font-black uppercase text-slate-400 ml-4 tracking-widest">Email Address</label><input type="email" id="auth-email" required class="w-full p-5 bg-white border border-slate-200 rounded-2xl outline-none font-bold shadow-sm focus:ring-4 ring-emerald-500/10 transition-all" placeholder="admin@enterprise.com"></div>
                    <div class="space-y-1.5 relative text-left font-sans">
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-4 tracking-widest">Secret pattern</label>
                        <input type="password" id="auth-password" required class="w-full p-5 bg-white border border-slate-200 rounded-2xl outline-none font-bold shadow-sm focus:ring-4 ring-emerald-500/10 transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <button type="button" onclick="window.toggleAuthPw()" class="absolute right-4 bottom-4 text-slate-300 hover:text-brand transition-colors"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                    </div>
                    <div id="auth-error" class="hidden p-4 bg-rose-50 text-rose-600 text-xs font-bold rounded-2xl border border-rose-100 animate-pulse"></div>
                    <button type="submit" id="auth-btn" class="w-full py-5 btn-brand rounded-2xl font-black uppercase text-xs tracking-widest mt-6 shadow-xl active:scale-95 transition-all">Authorize Session</button>
                </form>
                <div class="mt-10 flex justify-center border-t border-slate-200 pt-8">
                    <button id="auth-switch-btn" onclick="window.switchAuthMode()" class="text-[11px] font-black text-emerald-600 uppercase tracking-widest hover:underline underline-offset-8 transition-all">Provision New Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Shell -->
    <div id="app-shell" class="min-h-screen flex hidden overflow-hidden">
        <div id="drawer-backdrop" class="fixed inset-0 z-[55] bg-slate-900/40 backdrop-blur-sm hidden" onclick="window.toggleMenu()"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="fixed md:sticky top-0 left-0 h-screen w-[280px] bg-white border-r border-slate-200 z-[60] flex flex-col transition-transform duration-300 -translate-x-full md:translate-x-0">
            <div class="p-10 flex items-center gap-4">
                <div id="sidebar-logo"></div>
                <div class="text-left">
                    <h1 id="shop-label" class="font-extrabold text-xl tracking-tighter truncate w-32 leading-none text-slate-900 uppercase font-sans">...</h1>
                    <span class="text-[9px] font-black uppercase text-emerald-600 tracking-widest opacity-80 leading-none block mt-1">Enterprise</span>
                </div>
            </div>
            <nav id="nav-list" class="flex-1 px-4 space-y-1.5 overflow-y-auto no-scrollbar"></nav>
            <div class="p-8 border-t border-slate-50">
                <button onclick="window.handleLogout()" class="w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-rose-500 hover:bg-rose-50 transition-all group">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="group-hover:-translate-x-1 transition-transform"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>
                    <span id="logout-label" class="text-[10px] uppercase tracking-widest font-black leading-none">Sign Out</span>
                </button>
            </div>
        </aside>

        <!-- Main Body -->
        <main class="flex-1 flex flex-col min-w-0">
            <header class="sticky top-0 z-50 glass-header p-4 md:px-12 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button id="hamburger" class="p-2.5 text-slate-500 md:hidden bg-slate-100 rounded-xl" onclick="window.toggleMenu()"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
                    <h2 id="view-title" class="font-black uppercase tracking-tight text-slate-800 text-xs md:text-lg leading-none">Dashboard</h2>
                </div>
                <div class="flex items-center gap-3">
                    <div id="ai-chip" class="hidden lg:flex items-center gap-2 px-3 py-1.5 bg-emerald-50 text-emerald-700 rounded-full text-[9px] font-black uppercase border border-emerald-100 shadow-sm"><span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span> ‚ú® AI Active</div>
                    <button onclick="window.setView('profile')" class="w-10 h-10 bg-white border border-slate-200 rounded-full flex items-center justify-center text-slate-500 shadow-sm transition-all hover:scale-105 active:scale-95"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></button>
                </div>
            </header>
            <div id="viewport" class="p-4 md:p-12 flex-1 overflow-y-auto custom-scroll no-scrollbar"></div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-root" class="fixed inset-0 z-[500] hidden flex items-center justify-center p-0 md:p-4 bg-slate-950/40 backdrop-blur-sm animate-render"></div>
    <div id="ai-loading" class="fixed inset-0 z-[2000] bg-white/95 backdrop-blur-3xl hidden flex flex-col items-center justify-center p-10"><div class="w-16 h-16 bg-emerald-600 rounded-3xl animate-bounce mb-6 shadow-2xl"></div><p class="font-black uppercase text-[10px] tracking-[0.5em] text-emerald-600 animate-pulse">Neural Syncing</p></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, addDoc, updateDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL DEFINITIONS & ATTACHMENTS ---
        window.ui = (id) => document.getElementById(id);
        window.safeSet = (id, html) => { const el = window.ui(id); if (el) el.innerHTML = html; };
        
        window.LogoSVG = function(s) {
            return `
                <svg width="${s}" height="${s}" viewBox="0 0 100 100">
                    <rect width="100" height="100" rx="30" fill="#064E3B"/><path d="M30 70C30 65 40 60 50 60C60 60 70 65 70 70V30C70 20 60 15 50 15C40 15 30 20 30 30V70Z" fill="#10B981" /><circle cx="50" cy="38" r="8" fill="white" /><path d="M50 48V62" stroke="white" stroke-width="6" stroke-linecap="round"/>
                </svg>
            `;
        };

        window.Icons = {
            dashboard: '<path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>',
            inventory: '<path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>',
            pos: '<path d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>',
            reports: '<path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>',
            staff: '<path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>',
            settings: '<path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>',
            expense: '<path d="M12 8c-1.657 0-3 1.343-3 3s1.343 3 3 3 3-1.343 3-3-1.343-3-3-3z M2 17V7a2 2 0 012-2h16a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z M12 5v14 M2 12h20"/>',
            trash: '<path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>',
            edit: '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>',
            wand: '<path d="M15 4V2m0 16v-2M8 11h-2m16 0h-2m-1.5-6.5l-1.5 1.5m-9 9l-1.5 1.5m10.5 0l-1.5-1.5m-9-9l-1.5-1.5" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>',
            speaker: '<path d="M11 5L6 9H2v6h4l5 4V5zM19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>'
        };

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBoykIG0x3CnpQYw-Pp2Loq7t2fIw3Awqo",
            authDomain: "sobujsathi-library-ff7b9.firebaseapp.com",
            projectId: "sobujsathi-library-ff7b9",
            storageBucket: "sobujsathi-library-ff7b9.firebasestorage.app",
            messagingSenderId: "86448141188",
            appId: "1:86448141188:web:07577bacac4b00ff9f23d1",
            measurementId: "G-6NPKKGK8D7"
        };

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);
        const appId = 'enterprise-pos-v48-ai-master';
        const apiKey = ""; // Gemini Runtime

        const state = {
            user: null, view: 'dashboard', inventory: [], staff: [], activity: [], expenses: [],
            isAiLoading: false, aiAdvice: '', search: '', cart: [], isSignUp: false,
            config: { currency: '‡ß≥', lowStock: 5, lang: 'bn' },
            profile: { shopName: '‡¶∏‡¶¨‡ßÅ‡¶ú ‡¶∏‡¶æ‡¶•‡ßÄ ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡ßÄ', owner: 'Manager' }
        };

        const i18n = {
            bn: {
                dashboard: "‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°", inventory: "‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø", pos: "‡¶ü‡¶æ‡¶∞‡ßç‡¶Æ‡¶ø‡¶®‡¶æ‡¶≤", reports: "‡¶Ö‡¶°‡¶ø‡¶ü ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü", staff: "‡¶ü‡¶ø‡¶Æ ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞", settings: "‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ", profile: " Identity ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤", expense: "‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ",
                rev: "‡¶Æ‡ßã‡¶ü ‡¶∞‡ßá‡¶≠‡¶ø‡¶®‡¶ø‡¶â", profit: "‡¶Æ‡ßã‡¶ü ‡¶≤‡¶æ‡¶≠", worth: "‡¶™‡¶£‡ßç‡¶Ø ‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø", potential: "‡¶™‡¶£‡ßç‡¶Ø ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø", items: "‡¶™‡¶£‡ßç‡¶Ø ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ", totalExpense: "‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º", net: "‡¶™‡ßç‡¶∞‡¶ï‡ßÉ‡¶§ ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ",
                buy: "‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø", sell: "MRP", margin: "‡¶≤‡¶æ‡¶≠", stock: "‡¶∏‡ßç‡¶ü‡¶ï", asset: "‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø", units: "‡¶Æ‡ßã‡¶ü ‡¶á‡¶â‡¶®‡¶ø‡¶ü", range: "‡¶á‡¶â‡¶®‡¶ø‡¶ï ‡¶™‡¶£‡ßç‡¶Ø",
                add: "‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶£‡ßç‡¶Ø", save: "‡¶∏‡ßá‡¶≠", lang: "‡¶≠‡¶æ‡¶∑‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®", sync: "‚ú® AI ‡¶è‡¶®‡¶æ‡¶≤‡¶æ‡¶á‡¶∏‡¶ø‡¶∏", signout: "‡¶∏‡ßá‡¶∂‡¶® ‡¶∂‡ßá‡¶∑ ‡¶ï‡¶∞‡ßÅ‡¶®", negotiate: "‡¶¶‡¶∞‡¶¶‡¶æ‡¶Æ (Bargain)", checkout: "‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®",
                empty: "‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø", desc: "‡¶¨‡¶ø‡¶¨‡¶∞‡¶£", amount: "‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£", date: "‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ", wandDesc: "‚ú® AI ‡¶¨‡¶∞‡ßç‡¶£‡¶®‡¶æ", cancel: "‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®", onboard: "‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®"
            },
            en: {
                dashboard: "Dashboard", inventory: "Inventory", pos: "POS Console", reports: "Audit Log", staff: "Staff Team", settings: "Settings", profile: "Profile Identity", expense: "Expenses",
                rev: "Total Revenue", profit: "Gross Profit", worth: "Asset (Cost)", potential: "Asset (Market)", items: "Active SKUs", totalExpense: "Expenses", net: "Net Profit",
                buy: "Unit Cost", sell: "MRP", margin: "Margin", stock: "Stock", asset: "Market Realization", units: "Total Stock", range: "Product Range",
                add: "Add New", save: "Save Changes", lang: "Language", sync: "‚ú® Request AI Brief", signout: "Log Out", negotiate: "Price Override", checkout: "Settle Order",
                empty: "Cart is empty", desc: "Description", amount: "Amount", date: "Date", indiv: "Stock Value", wandDesc: "‚ú® AI Blurb", cancel: "Cancel", onboard: "Add Associate"
            }
        };

        const t = (k) => i18n[state.config.lang][k] || k;

        // ==========================================
        // ‚ú® GEMINI AI ENGINE
        // ==========================================
        async function callGemini(prompt, sys = "Enterprise ERP Strategist.") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: String(prompt) }] }], systemInstruction: { parts: [{ text: String(sys) }] } })
                });
                const d = await response.json();
                return d.candidates?.[0]?.content?.parts?.[0]?.text || "AI ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§";
            } catch(e) { return "AI ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡¶ø‡¶ö‡ßç‡¶õ‡¶ø‡¶®‡ßç‡¶®‡•§"; }
        }

        async function speakAi(text) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Say naturally in Bengali: ${text}` }] }],
                        generationConfig: { 
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                        }
                    })
                });
                const result = await response.json();
                const base64 = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                if (base64) {
                    const audio = new Audio("data:audio/wav;base64," + base64);
                    audio.play();
                }
            } catch (e) { console.error("TTS Node Failure"); }
        }

        // --- RENDER CONTROLLER ---
        window.render = function() {
            if (!state.user) {
                window.ui('auth-screen')?.classList.remove('hidden');
                window.ui('app-shell')?.classList.add('hidden');
                window.safeSet('auth-logo-pane', window.LogoSVG(110));
                window.safeSet('auth-logo-mobile', window.LogoSVG(80));
                return;
            }
            
            window.ui('auth-screen')?.classList.add('hidden');
            window.ui('app-shell')?.classList.remove('hidden');
            window.ui('ai-loading')?.classList.toggle('hidden', !state.isAiLoading);
            window.safeSet('sidebar-logo', window.LogoSVG(40));
            
            const shopLabel = window.ui('shop-label');
            if(shopLabel) shopLabel.innerText = state.profile.shopName;
            const viewTitle = window.ui('view-title');
            if(viewTitle) viewTitle.innerText = t(state.view);
            const logoutLabel = window.ui('logout-label');
            if(logoutLabel) logoutLabel.innerText = t('signout');

            const menu = [
                { id: 'dashboard', icon: window.Icons.dashboard },
                { id: 'inventory', icon: window.Icons.inventory },
                { id: 'pos', icon: window.Icons.pos },
                { id: 'expense', icon: window.Icons.expense },
                { id: 'reports', icon: window.Icons.reports },
                { id: 'staff', icon: window.Icons.staff },
                { id: 'settings', icon: window.Icons.settings }
            ];

            window.safeSet('nav-list', menu.map(n => `
                <button onclick="window.setView('${n.id}')" class="sidebar-item w-full flex items-center gap-4 p-5 rounded-2xl font-bold transition-all ${state.view === n.id ? 'sidebar-active shadow-sm' : 'text-slate-400 hover:bg-slate-50'}">
                    <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.5"><path d="${n.icon}" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <span class="text-[11px] uppercase tracking-widest font-black leading-none">${t(n.id)}</span>
                </button>
            `).join(''));

            const viewport = window.ui('viewport');
            if(viewport) viewport.innerHTML = `<div class="animate-render space-y-10 pb-20">${window.getViewHTML()}</div>`;
        };

        window.getViewHTML = function() {
            switch(state.view) {
                case 'dashboard': return window.renderDashboard();
                case 'inventory': return window.renderInventory();
                case 'pos': return window.renderPOS();
                case 'expense': return window.renderExpenses();
                case 'reports': return window.renderReports();
                case 'staff': return window.renderStaff();
                case 'settings': return window.renderSettings();
                case 'profile': return window.renderProfile();
                default: return '';
            }
        };

        // --- DASHBOARD RENDERER ---
        window.renderDashboard = function() {
            const rev = state.activity.reduce((s, a) => s + (a.total || 0), 0);
            const profitTotal = state.activity.reduce((s, a) => s + (a.profit || 0), 0);
            const expSum = state.expenses.reduce((s, e) => s + (e.amount || 0), 0);
            const net = profitTotal - expSum;
            
            const totalUnits = state.inventory.reduce((s, i) => s + Number(i.stock), 0);
            const capital = state.inventory.reduce((s, i) => s + (Number(i.buyPrice) * Number(i.stock)), 0);
            const realization = state.inventory.reduce((s, i) => s + ((Number(i.price) * (1 - (Number(i.discount)/100))) * Number(i.stock)), 0);

            return `
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-10 text-left font-sans">
                    <div class="card-enterprise p-8 border-l-[10px] border-indigo-600 relative overflow-hidden">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">${t('rev')}</p>
                        <h3 class="text-3xl font-extrabold text-slate-900 leading-none tracking-tighter">‡ß≥${Math.round(rev).toLocaleString()}</h3>
                    </div>
                    <div class="card-enterprise p-8 border-l-[10px] border-emerald-500">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">${t('profit')}</p>
                        <h3 class="text-3xl font-extrabold text-emerald-600 leading-none tracking-tighter">‡ß≥${Math.round(profitTotal).toLocaleString()}</h3>
                    </div>
                    <div class="card-enterprise p-8 border-l-[10px] border-rose-500">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">${t('totalExpense')}</p>
                        <h3 class="text-3xl font-extrabold text-rose-500 leading-none tracking-tighter">‡ß≥${Math.round(expSum).toLocaleString()}</h3>
                    </div>
                    <div class="card-enterprise p-8 bg-indigo-600 text-white shadow-xl">
                        <p class="text-[10px] font-black opacity-80 uppercase tracking-widest mb-1">${t('net')}</p>
                        <h3 class="text-3xl font-extrabold leading-none tracking-tighter">‡ß≥${Math.round(net).toLocaleString()}</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 text-left">
                    <div class="lg:col-span-1 card-enterprise p-10 space-y-10 bg-white font-sans">
                        <h3 class="font-black text-xs uppercase tracking-widest text-slate-400 flex items-center gap-2">Logistical Intelligence</h3>
                        <div class="grid grid-cols-2 gap-8">
                            <div><p class="text-[9px] font-bold uppercase text-slate-400 mb-1">${t('range')}</p><h4 class="text-2xl font-black text-slate-900 leading-none">${state.inventory.length}</h4></div>
                            <div><p class="text-[9px] font-bold uppercase text-slate-400 mb-1">Units</p><h4 class="text-2xl font-black text-emerald-600 leading-none">${totalUnits}</h4></div>
                        </div>
                        <div class="pt-6 border-t space-y-8">
                            <div><p class="text-[9px] font-bold uppercase text-slate-400 mb-1">Asset (Cost)</p><h4 class="text-3xl font-black text-slate-900 leading-none tracking-tighter">‡ß≥${Math.round(capital).toLocaleString()}</h4></div>
                            <div><p class="text-[9px] font-bold uppercase text-slate-400 mb-1">Asset (Market)</p><h4 class="text-3xl font-black text-emerald-600 leading-none tracking-tighter">‡ß≥${Math.round(realization).toLocaleString()}</h4></div>
                        </div>
                    </div>

                    <div class="lg:col-span-2 bg-slate-900 p-10 md:p-14 rounded-[3.5rem] text-white shadow-2xl relative overflow-hidden flex flex-col justify-center">
                        <div class="absolute -top-10 -right-10 w-80 h-80 bg-emerald-500/10 rounded-full blur-[120px]"></div>
                        <h2 class="text-2xl font-black uppercase tracking-tight relative z-10 mb-6 flex items-center gap-3 leading-none font-sans">‚ú® AI Strategic Brief</h2>
                        <div class="bg-white/5 border border-white/10 p-8 rounded-[2rem] text-sm italic text-slate-300 leading-relaxed min-h-[140px] custom-scroll">
                            ${state.aiAdvice || "‡¶™‡ßç‡¶∞‡¶¨‡ßÉ‡¶¶‡ßç‡¶ß‡¶ø ‡¶Ö‡¶∞‡ßç‡¶ú‡¶®‡ßá AI ‡¶è‡¶®‡¶æ‡¶≤‡¶æ‡¶á‡¶∏‡¶ø‡¶∏ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®..."}
                        </div>
                        <div class="flex gap-4 mt-10 relative z-10">
                            <button onclick="window.runAiBrief()" class="px-8 py-4 bg-emerald-600 hover:bg-emerald-50 rounded-2xl font-black uppercase text-[10px] tracking-widest transition-all active:scale-95 shadow-xl">‚ú® ‡¶è‡¶®‡¶æ‡¶≤‡¶æ‡¶á‡¶∏‡¶ø‡¶∏</button>
                            ${state.aiAdvice ? `<button onclick="window.listenAi()" class="p-4 bg-slate-800 rounded-2xl transition-all active:scale-90"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="${window.Icons.speaker}"/></svg></button>` : ''}
                        </div>
                    </div>
                </div>
            `;
        };

        // --- CORE SYSTEM ACTIONS ---
        window.setView = (v) => { state.view = v; state.search = ''; window.render(); if(window.innerWidth < 768) { window.ui('sidebar')?.classList.add('-translate-x-full'); window.ui('sidebar-overlay')?.classList.add('hidden'); }};
        window.handleSearch = (v) => { state.search = v; window.render(); };
        window.handleLogout = () => signOut(auth);
        window.toggleCart = () => window.ui('pos-drawer')?.classList.toggle('open');
        window.toggleMenu = () => { window.ui('sidebar')?.classList.toggle('-translate-x-full'); window.ui('sidebar-overlay')?.classList.toggle('hidden'); };
        window.closeModal = () => window.ui('modal-root')?.classList.add('hidden');
        window.toggleAuthPw = () => { const inp = window.ui('auth-password'); if(inp) inp.type = inp.type === 'password' ? 'text' : 'password'; };

        window.runAiBrief = async () => {
            state.isAiLoading = true; window.render();
            const profit = state.activity.reduce((s,a) => s + (a.profit || 0), 0);
            const exp = state.expenses.reduce((s,e) => s + (e.amount || 0), 0);
            const prompt = `‡¶≤‡¶æ‡¶≠: ${profit}, ‡¶ñ‡¶∞‡¶ö: ${exp}‡•§ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶¨‡ßÉ‡¶¶‡ßç‡¶ß‡¶ø ‡¶Ö‡¶∞‡ßç‡¶ú‡¶®‡ßá ‡ß©‡¶ü‡¶ø ‡¶ï‡ßå‡¶∂‡¶≤ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡ßü ‡¶¶‡¶ø‡¶®‡•§`;
            state.aiAdvice = await callGemini(prompt, "Strategic Auditor.");
            state.isAiLoading = false; window.render();
        };

        window.listenAi = () => speakAi(state.aiAdvice);

        window.genAiBlurb = async () => {
            const nameInput = window.ui('m-name');
            if(!nameInput || !nameInput.value) return;
            state.isAiLoading = true; window.render();
            const prompt = `‡¶™‡¶£‡ßç‡¶Ø: ${nameInput.value}‡•§ ‡¶¨‡¶∞‡ßç‡¶£‡¶®‡¶æ ‡ßß ‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡ßü‡•§`;
            const res = await callGemini(prompt, "Copywriter.");
            alert(`‚ú® AI Suggestion: ${res}`);
            state.isAiLoading = false; window.render();
        };

        // --- INVENTORY ---
        window.renderInventory = function() {
            const filtered = state.inventory.filter(i => i.name.toLowerCase().includes(state.search.toLowerCase()));
            return `
                <div class="card-enterprise p-6 flex flex-col md:flex-row gap-4 items-center mb-10 text-left font-sans">
                    <div class="relative flex-1 w-full text-left">
                        <input type="text" oninput="window.handleSearch(this.value)" value="${state.search}" placeholder="Search products..." class="w-full pl-14 pr-4 py-5 bg-slate-100/50 rounded-3xl border-none outline-none font-bold text-sm shadow-inner focus:ring-4 ring-emerald-500/10">
                        <div class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div>
                    </div>
                    <button onclick="window.openProductModal()" class="w-full md:w-auto px-10 py-5 btn-brand rounded-3xl font-black uppercase text-[10px] tracking-widest shadow-xl transition-all">${t('add')}</button>
                </div>
                <div class="overflow-hidden">
                    <div class="overflow-x-auto custom-scroll">
                        <table class="w-full text-left mobile-stack font-sans">
                            <thead class="bg-slate-50 border-b text-[10px] font-black uppercase tracking-widest text-slate-400">
                                <tr><th class="p-8">Resource</th><th class="p-8 text-center">Lifecycle</th><th class="p-8 text-right">Price</th><th class="p-8"></th></tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50 bg-white">
                                ${filtered.map(i => `
                                    <tr class="hover:bg-slate-50/50 transition-all card-enterprise mb-4 md:mb-0 md:border-none">
                                        <td class="p-8 leading-none" data-label="Resource"><div><p class="font-bold text-slate-900 mb-2 leading-tight">${i.name}</p><span class="px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded text-[9px] uppercase font-black font-sans border border-emerald-200">${i.category}</span></div></td>
                                        <td class="p-8 text-center font-bold" data-label="Lifecycle"><span class="px-4 py-2 rounded-full text-[10px] ${i.stock <= state.config.lowStock ? 'bg-rose-50 text-rose-500' : 'bg-slate-100 text-slate-500'} font-sans">${i.stock} units</span></td>
                                        <td class="p-8 text-right font-black text-slate-900 text-lg">‡ß≥${i.price}</td>
                                        <td class="p-8 text-right"><button onclick="window.openProductModal('${i.id}')" class="p-3 bg-slate-100 hover:bg-emerald-100 rounded-xl text-slate-400 hover:text-brand transition-all active:scale-90"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5"><path d="${window.Icons.edit}"/></svg></button></td>
                                    </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        // --- POS TERMINAL ---
        window.renderPOS = function() {
            return `
                <div class="flex flex-col lg:flex-row gap-8 relative h-full">
                    <div class="flex-1 space-y-8 text-left font-sans">
                        <div class="card-enterprise p-4 bg-white shadow-inner flex items-center"><input type="text" oninput="window.handleSearch(this.value)" value="${state.search}" placeholder="Product search..." class="w-full p-4 bg-transparent border-none font-bold text-sm outline-none"></div>
                        <div class="product-grid">
                            ${state.inventory.filter(i => i.name.toLowerCase().includes(state.search.toLowerCase())).map(i => `
                                <button onclick="window.addToCart('${i.id}')" class="card-enterprise p-6 md:p-8 text-left h-52 flex flex-col justify-between active:scale-95 group relative overflow-hidden transition-all">
                                    <div class="leading-tight font-sans"><span class="text-[8px] font-black uppercase text-slate-300 block mb-2 leading-none">${i.category}</span><p class="font-bold text-slate-800 line-clamp-2 text-sm">${i.name}</p></div>
                                    <div class="font-sans font-black text-emerald-600 text-xl leading-none">‡ß≥${i.price}</div>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    <div id="pos-drawer" class="pos-sheet bg-white border-l border-slate-100 p-8 md:p-12 flex flex-col lg:h-[calc(100vh-140px)] lg:w-[420px] overflow-hidden transition-transform duration-300">
                        <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-10 lg:hidden cursor-pointer" onclick="window.toggleCart()"></div>
                        <h3 class="text-[11px] font-black uppercase tracking-[0.3em] text-slate-300 mb-10 text-center leading-none font-sans">Checkout Manifest</h3>
                        <div class="flex-1 overflow-y-auto pr-2 space-y-6 custom-scroll no-scrollbar">
                            ${state.cart.length ? state.cart.map((item, idx) => `
                                <div class="cart-item flex flex-col bg-slate-50/50 p-6 rounded-[2.5rem] border border-slate-100 animate-render space-y-5 text-left font-sans">
                                    <div class="flex justify-between items-start leading-tight"><p class="text-xs font-bold text-slate-900 truncate w-40 leading-tight font-sans">${item.name}</p><button onclick="window.removeFromCart(${idx})" class="text-rose-300 hover:text-rose-50 transition-colors active:scale-90"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5"><path d="${window.Icons.trash}"/></svg></button></div>
                                    <div class="flex justify-between items-center bg-white p-2.5 rounded-3xl border border-slate-200">
                                        <div class="flex items-center gap-4">
                                            <button onclick="window.updateCartQty('${item.id}', -1)" class="w-8 h-8 flex items-center justify-center bg-slate-50 rounded-full font-black text-slate-500 hover:bg-rose-50 transition-all">-</button>
                                            <span class="text-xs font-black w-4 text-center font-sans">${item.quantity}</span>
                                            <button onclick="window.updateCartQty('${item.id}', 1)" class="w-8 h-8 flex items-center justify-center bg-slate-50 rounded-full font-black text-slate-500 hover:bg-emerald-50 transition-all">+</button>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-[8px] font-black text-slate-400 uppercase tracking-tighter">${t('negotiate')}:</span>
                                            <input type="number" onchange="window.updateCartPrice('${item.id}', this.value)" value="${item.price}" class="w-16 p-1.5 bg-slate-100 border-none rounded-lg text-right font-black text-emerald-600 text-xs shadow-inner focus:ring-2 ring-emerald-500/10 transition-all">
                                        </div>
                                    </div>
                                </div>`).join('') : '<div class="h-64 flex flex-col items-center justify-center text-slate-200 opacity-50 font-sans leading-none"><p class="text-[10px] font-black uppercase tracking-widest mt-10 text-center">Empty Cart</p></div>'}
                        </div>
                        <div class="pt-10 border-t mt-6 bg-white font-sans text-left">
                            <div class="flex justify-between items-end mb-8 font-sans">
                                <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest leading-none">Gross Settle</span>
                                <span class="text-5xl font-black text-slate-900 tracking-tighter leading-none">‡ß≥${state.cart.reduce((s,i) => s + (i.price * i.quantity), 0).toLocaleString()}</span>
                            </div>
                            <button onclick="window.checkout()" class="w-full py-7 bg-slate-900 text-white rounded-[2.5rem] font-black uppercase text-xs tracking-widest active:scale-95 transition-all shadow-2xl disabled:opacity-30" ${!state.cart.length ? 'disabled' : ''}>${t('checkout')}</button>
                        </div>
                    </div>
                </div>
            `;
        };

        // --- STAFF RENDERER ---
        window.renderStaff = () => `
            <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-10 text-left font-sans">
                <h3 class="text-3xl font-black uppercase tracking-tighter leading-none">${t('staff')}</h3>
                <button onclick="window.openStaffModal()" class="w-full md:w-auto px-10 py-5 btn-brand rounded-[2rem] font-black text-[10px] uppercase shadow-2xl transition-all">${t('onboard')}</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 text-center font-sans">
                ${state.staff.map(m => `
                    <div class="card-enterprise p-12 relative group animate-render">
                        <div class="w-20 h-20 bg-slate-50 rounded-[2.5rem] mx-auto mb-6 flex items-center justify-center text-emerald-600 shadow-inner text-3xl leading-none">üë§</div>
                        <h4 class="text-2xl font-extrabold text-slate-900 mb-1 leading-none font-sans">${m.name}</h4>
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-8 leading-none font-sans">${m.role}</span>
                        <button onclick="window.draftPerformanceReview('${m.name}', '${m.role}')" class="w-full py-3 bg-slate-100 rounded-xl font-bold text-[9px] uppercase tracking-widest hover:bg-emerald-600 hover:text-white transition-all active:scale-95">‚ú® AI Audit</button>
                        <button onclick="window.deleteStaff('${m.id}')" class="absolute top-6 right-6 text-slate-200 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-all active:scale-90"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="${window.Icons.trash}"/></svg></button>
                    </div>
                `).join('')}
            </div>
        `;

        window.openStaffModal = () => {
            const root = window.ui('modal-root');
            if(!root) return;
            root.innerHTML = `<div class="bg-white rounded-[4rem] w-full max-w-md p-14 text-center shadow-2xl animate-render font-sans"><form id="s-form" class="space-y-8 leading-none"><h4 class="text-xl font-black uppercase text-slate-300 leading-none">Recruit associate</h4><input id="s-name" placeholder="Full Legal Name" required class="w-full p-6 bg-slate-100 rounded-3xl outline-none font-bold text-lg text-center border-none shadow-inner focus:ring-4 ring-emerald-500/10"><select id="s-role" class="w-full p-6 bg-slate-100 rounded-3xl font-bold text-center border-none shadow-inner outline-none focus:ring-4 ring-emerald-500/10"><option value="Manager">Manager</option><option value="Associate">Associate</option></select><div class="flex gap-4"><button type="submit" class="flex-1 py-7 bg-slate-900 text-white rounded-[2.5rem] font-black uppercase text-xs tracking-widest shadow-xl active:scale-95 transition-all">Commit</button><button type="button" onclick="window.closeModal()" class="px-8 py-7 bg-slate-100 text-slate-400 rounded-[2.5rem] font-black uppercase text-xs active:bg-rose-50 active:scale-90 transition-all">${t('cancel')}</button></div></form></div>`;
            root.classList.remove('hidden');
            window.ui('s-form').onsubmit = async (e) => { e.preventDefault(); await addDoc(collection(db, 'artifacts', appId, 'users', state.user.uid, 'staff'), { name: window.ui('s-name').value, role: window.ui('s-role').value }); window.closeModal(); };
        };

        // --- EXPENSES, REPORTS, SETTINGS, PROFILE ---
        window.renderExpenses = () => `<div class="flex flex-col lg:flex-row gap-10 text-left animate-render font-sans"><div class="flex-1 card-enterprise p-10 space-y-6"><h3 class="text-2xl font-black uppercase flex items-center gap-3 leading-none tracking-tighter"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="${window.Icons.expense}"/></svg> Expense Registry</h3><div class="overflow-hidden border border-slate-100 rounded-3xl"><table class="w-full text-left mobile-card-mode"><thead class="bg-slate-50 text-[10px] font-black uppercase tracking-widest text-slate-400 border-b"><tr><th class="p-6">Desc</th><th class="p-6 text-right font-sans">Cost</th><th class="p-6"></th></tr></thead><tbody class="divide-y divide-slate-50 bg-white">${state.expenses.map(e => `<tr><td class="p-6 font-bold" data-label="Desc">${e.desc}</td><td class="p-6 text-right font-black text-rose-500 font-sans">‡ß≥${e.amount}</td><td class="p-6 text-right"><button onclick="window.deleteExpense('${e.id}')" class="text-slate-300 hover:text-rose-500 active:scale-90 transition-all"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5"><path d="${window.Icons.trash}"/></svg></button></td></tr>`).join('')}</tbody></table></div></div><div class="lg:w-[380px] card-enterprise p-10 bg-white border border-slate-200 shadow-xl"><form id="exp-form" onsubmit="window.handleExpenseSubmit(event)" class="space-y-4 text-center"><h3 class="font-black uppercase text-[11px] mb-10 tracking-widest text-slate-300 leading-none font-sans">New Entry</h3><input id="e-desc" placeholder="Purpose" required class="w-full p-5 bg-slate-50 rounded-2xl font-bold border-none shadow-inner outline-none"><input id="e-amount" type="number" placeholder="Cost" required class="w-full p-5 bg-slate-50 rounded-2xl font-bold border-none shadow-inner outline-none"><button type="submit" class="w-full py-6 bg-slate-900 text-white rounded-[2rem] font-black uppercase text-xs active:scale-95 transition-all mt-4 shadow-xl">Record Entry</button></form></div></div>`;
        window.renderReports = () => `<div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-10 text-center md:text-left animate-view font-sans"><h3 class="text-3xl font-black uppercase tracking-tighter leading-none">Enterprise Audit</h3><button onclick="window.exportPDF()" class="px-10 py-5 bg-slate-900 text-white rounded-[2rem] font-black text-[10px] uppercase shadow-2xl active:scale-95 transition-all">Download Summary</button></div><div class="card-enterprise overflow-hidden bg-white shadow-xl"><table class="w-full text-left mobile-stack font-sans"><thead class="bg-slate-50 border-b text-[10px] font-black uppercase tracking-widest text-slate-400"><tr><th class="p-6 text-left">Date</th><th class="p-6 text-left">Activity</th><th class="p-6 text-right font-sans">Rev</th><th class="p-6 text-right font-sans">Net</th></tr></thead><tbody class="divide-y divide-slate-50 bg-white">${state.activity.map(a => `<tr><td class="p-6 text-[11px] font-bold text-slate-400 font-sans" data-label="Date">${new Date(a.time).toLocaleDateString()}</td><td class="p-6 font-bold text-slate-900 text-left" data-label="Activity">${a.manifest || a.desc}</td><td class="p-6 text-right font-black text-slate-900 font-sans">‡ß≥${(a.total || 0).toLocaleString()}</td><td class="p-6 text-right font-black text-emerald-600 font-sans">‡ß≥${(a.profit || 0).toLocaleString()}</td></tr>`).join('')}</tbody></table></div>`;
        window.renderSettings = () => `<div class="max-w-2xl mx-auto card-enterprise p-10 md:p-14 space-y-12 animate-render text-center leading-none font-sans"><h3 class="text-3xl font-black uppercase tracking-tight text-slate-900 leading-none font-sans">Application Global</h3><div class="space-y-8 mt-10"><div class="flex flex-col md:flex-row justify-between items-center p-8 bg-slate-50 rounded-[3rem] gap-4"><div><p class="font-bold text-slate-900 text-base">Localization</p></div><select id="set-lang" class="p-4 bg-white border border-slate-200 rounded-2xl font-bold outline-none shadow-sm focus:ring-4 ring-emerald-500/10 transition-all font-sans"><option value="bn" ${state.config.lang === 'bn' ? 'selected' : ''}>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</option><option value="en" ${state.config.lang === 'en' ? 'selected' : ''}>English</option></select></div><button onclick="window.saveSettings()" class="w-full py-7 bg-slate-900 text-white rounded-[2.5rem] font-black uppercase text-xs tracking-widest active:scale-95 shadow-2xl transition-all">Update Parameters</button></div></div>`;
        window.renderProfile = () => `<div class="max-w-2xl mx-auto card-enterprise p-10 md:p-16 space-y-10 animate-render text-center font-sans"><div class="mb-6 flex justify-center p-8 bg-slate-50 rounded-[4rem] shadow-inner w-36 h-36 mx-auto">${window.LogoSVG(80)}</div><h3 class="text-3xl font-black text-slate-900 leading-none uppercase tracking-tighter font-sans">Identity Authorized</h3><div class="grid grid-cols-2 gap-4"><div class="bg-indigo-50/50 p-8 rounded-3xl border border-indigo-100 shadow-sm text-center font-sans"><p class="text-[9px] font-black uppercase text-indigo-400 mb-1 tracking-widest leading-none">Portfolio total</p><h4 class="text-xl font-black text-indigo-600 leading-none mt-2 font-sans">‡ß≥${state.activity.reduce((s, a) => s + (a.total || 0), 0).toLocaleString()}</h4></div><div class="bg-emerald-50/50 p-8 rounded-3xl border border-emerald-100 shadow-sm text-center font-sans"><p class="text-[9px] font-black uppercase text-emerald-400 mb-1 tracking-widest leading-none font-sans">Team Unit</p><h4 class="text-xl font-black text-emerald-600 leading-none mt-2 font-sans">${state.staff.length} Associate</h4></div></div><div class="space-y-6 text-left border-t pt-12"><div class="space-y-1"><label class="text-[10px] font-black uppercase text-slate-400 ml-4 tracking-widest font-sans">Shop Identity</label><input id="p-shop" value="${state.profile.shopName}" class="w-full p-5 bg-slate-50 rounded-2xl font-bold border-none outline-none shadow-inner text-lg focus:ring-4 ring-emerald-500/10 transition-all font-sans"></div><div class="space-y-1"><label class="text-[10px] font-black uppercase text-slate-400 ml-4 tracking-widest font-sans">Master identity</label><input id="p-owner" value="${state.profile.owner}" class="w-full p-5 bg-slate-50 rounded-2xl font-bold border-none outline-none shadow-inner text-lg focus:ring-4 ring-emerald-500/10 transition-all font-sans"></div><button onclick="window.saveProfile()" class="w-full py-7 btn-brand rounded-2xl font-black uppercase text-xs tracking-widest shadow-xl active:scale-95 transition-all">Update Instance Identity</button></div></div>`;

        window.openProductModal = (id = null) => {
            const i = id ? state.inventory.find(item => item.id === id) : { name: '', category: 'Book', price: 0, buyPrice: 0, stock: 0 };
            const root = window.ui('modal-root');
            if(!root) return;
            root.innerHTML = `
                <div class="bg-white md:rounded-[4rem] w-full max-w-2xl h-full md:h-auto overflow-y-auto shadow-2xl animate-render">
                    <form id="p-form" class="p-10 md:p-16 space-y-10 text-left font-sans">
                        <div class="flex justify-between items-center md:hidden mb-6"><h4 class="font-black uppercase text-slate-300">Registration</h4><button type="button" onclick="window.closeModal()" class="text-3xl font-light">‚úï</button></div>
                        <h4 class="hidden md:block text-2xl font-black uppercase text-slate-300 text-center leading-none mb-4 tracking-widest font-sans">Resource Node</h4>
                        <div class="flex gap-4 items-end">
                            <div class="flex-1 space-y-1.5"><label class="text-[10px] font-black uppercase text-slate-400 ml-6 tracking-widest">Label</label><input id="m-name" value="${i.name}" required class="w-full p-5 bg-slate-50 rounded-[2rem] border-none outline-none font-bold text-xl shadow-inner focus:ring-4 ring-emerald-500/10 transition-all"></div>
                            <button type="button" onclick="window.genAiBlurb()" class="p-5 bg-indigo-600 text-white rounded-3xl active:scale-90 transition-all flex items-center justify-center shadow-lg hover:bg-indigo-500 transition-all"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="${window.Icons.wand}"/></svg></button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 font-sans">
                            <div class="space-y-1.5"><label class="text-[10px] font-black uppercase text-slate-400 ml-6">Type</label><select id="m-cat" class="w-full p-5 bg-slate-50 rounded-[2rem] font-bold text-lg outline-none border-none shadow-inner"><option value="Book" ${i.category==='Book'?'selected':''}>Book</option><option value="Stationery" ${i.category==='Stationery'?'selected':''}>Stationery</option></select></div>
                            <div class="space-y-1.5"><label class="text-[10px] font-black uppercase text-slate-400 ml-6">Units</label><input id="m-stock" type="number" value="${i.stock}" required class="w-full p-5 bg-slate-50 rounded-[2rem] font-bold text-lg border-none shadow-inner"></div>
                            <div class="space-y-1.5"><label class="text-[10px] font-black uppercase text-emerald-600 ml-6 font-bold">Buy Price</label><input id="m-buy" type="number" value="${i.buyPrice || 0}" required class="w-full p-5 bg-emerald-50 rounded-[2rem] font-bold text-lg border border-emerald-100 outline-none"></div>
                            <div class="space-y-1.5"><label class="text-[10px] font-black uppercase text-slate-400 ml-6 font-bold">MRP</label><input id="m-price" type="number" value="${i.price}" required class="w-full p-5 bg-slate-50 rounded-[2rem] font-bold text-lg border-none shadow-inner outline-none"></div>
                        </div>
                        <div class="flex flex-col md:flex-row gap-4 pt-4"><button type="submit" class="flex-1 py-7 btn-brand rounded-[2.5rem] font-black uppercase text-xs tracking-widest shadow-xl">Commit Asset</button><button type="button" onclick="window.closeModal()" class="hidden md:block px-12 py-7 bg-slate-100 text-slate-400 rounded-[2.5rem] font-black uppercase text-xs active:scale-90 transition-all">Cancel</button></div>
                    </form>
                </div>
            `;
            root.classList.remove('hidden');
            window.ui('p-form').onsubmit = async (e) => {
                e.preventDefault();
                const d = { name: window.ui('m-name').value, category: window.ui('m-cat').value, stock: parseInt(window.ui('m-stock').value), buyPrice: parseFloat(window.ui('m-buy').value), price: parseFloat(window.ui('m-price').value), discount: 0 };
                const p = id ? doc(db, 'artifacts', appId, 'users', state.user.uid, 'inventory', id) : doc(collection(db, 'artifacts', appId, 'users', state.user.uid, 'inventory'));
                await setDoc(p, d, { merge: true });
                window.closeModal();
            };
        };

        window.addToCart = (id) => {
            const i = state.inventory.find(it => it.id === id);
            if(!i || i.stock <= 0) return alert("Sold out!");
            const existing = state.cart.find(c => c.id === id);
            if(existing) { if(existing.quantity < i.stock) existing.quantity += 1; } 
            else { const net = Math.round(i.price); state.cart.push({ ...i, price: net, profitAtSale: net - i.buyPrice, quantity: 1 }); }
            window.render();
            if(window.innerWidth < 1024) window.ui('pos-drawer')?.classList.add('open');
        };

        window.updateCartQty = (id, delta) => {
            const it = state.cart.find(c => c.id === id);
            const inv = state.inventory.find(i => i.id === id);
            if(it) { it.quantity += delta; if(it.quantity > inv.stock) it.quantity = inv.stock; if(it.quantity <= 0) state.cart = state.cart.filter(c => c.id !== id); window.render(); }
        };
        window.updateCartPrice = (id, v) => { const it = state.cart.find(c => c.id === id); if(it) { it.price = parseFloat(v); it.profitAtSale = it.price - it.buyPrice; window.render(); }};
        window.removeFromCart = (idx) => { state.cart.splice(idx, 1); window.render(); };

        window.checkout = async () => {
            if(!state.cart.length) return;
            state.isAiLoading = true; window.render();
            const total = state.cart.reduce((s,i) => s + (i.price * i.quantity), 0);
            const profit = state.cart.reduce((s,i) => s + (i.profitAtSale * i.quantity), 0);
            const manifest = state.cart.map(i => `${i.name} x${i.quantity}`).join(', ');
            const p = ['artifacts', appId, 'users', state.user.uid];
            try {
                await addDoc(collection(db, ...p, 'activity'), { manifest, total, profit, time: Date.now() });
                for(const it of state.cart) {
                    const orig = state.inventory.find(inv => inv.id === it.id);
                    await updateDoc(doc(db, ...p, 'inventory', it.id), { stock: Number(orig.stock) - it.quantity });
                }
                const msg = await callGemini(`Transaction: ${manifest}. Generate thank note.`, "Service.");
                state.cart = [];
                state.isAiLoading = false; window.render();
                alert(`‚úÖ Success\n\n‚ú® AI Note: ${msg}`);
            } catch(e) { state.isAiLoading = false; window.render(); }
        };

        window.handleExpenseSubmit = async (e) => { e.preventDefault(); const desc = window.ui('e-desc').value; const amount = parseFloat(window.ui('e-amount').value); await addDoc(collection(db, 'artifacts', appId, 'users', state.user.uid, 'expenses'), { desc, amount, time: Date.now() }); e.target.reset(); };
        window.deleteExpense = async (id) => { if(confirm("Terminate entry?")) await deleteDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'expenses', id)); };
        window.deleteStaff = async (id) => { if(confirm("Terminate Access?")) await deleteDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'staff', id)); };
        window.saveSettings = async () => { state.config.lang = window.ui('set-lang').value; await setDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'settings', 'config'), state.config); alert("Settings Applied!"); window.render(); };
        window.saveProfile = async () => { state.profile.shopName = window.ui('p-shop').value; state.profile.owner = window.ui('p-owner').value; await setDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'settings', 'profile'), state.profile); alert("Master Profile Saved!"); window.render(); };

        window.exportPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`${state.profile.shopName} - Performance Audit`, 14, 20);
            doc.autoTable({ startY: 30, head: [['Date', 'Activity', 'Total']], body: state.activity.map(a => [new Date(a.time).toLocaleDateString(), a.manifest || a.desc, `‡ß≥${a.total}`]) });
            doc.save('Enterprise_Audit.pdf');
        };

        window.switchAuthMode = () => {
            state.isSignUp = !state.isSignUp;
            window.ui('auth-title').innerText = state.isSignUp ? 'Provision Admin' : 'Workspace Login';
            window.ui('auth-btn').innerText = state.isSignUp ? 'Provision Instance' : 'Authorize Session';
            window.ui('auth-switch-btn').innerText = state.isSignUp ? 'Login to Existing' : 'Provision New Account';
        };

        // --- AUTH & FIREBASE LISTENERS ---
        onAuthStateChanged(auth, async (u) => {
            state.user = u;
            if (u) {
                const p = ['artifacts', appId, 'users', u.uid];
                onSnapshot(collection(db, ...p, 'inventory'), s => { state.inventory = s.docs.map(d => ({id: d.id, ...d.data()})); window.render(); });
                onSnapshot(collection(db, ...p, 'activity'), s => { state.activity = s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b)=>b.time-a.time); window.render(); });
                onSnapshot(collection(db, ...p, 'expenses'), s => { state.expenses = s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b)=>b.time-a.time); window.render(); });
                onSnapshot(collection(db, ...p, 'staff'), s => { state.staff = s.docs.map(d => ({id: d.id, ...d.data()})); window.render(); });
                const pr = await getDoc(doc(db, ...p, 'settings', 'profile')); if(pr.exists()) state.profile = pr.data();
                const cf = await getDoc(doc(db, ...p, 'settings', 'config')); if(cf.exists()) state.config = cf.data();
            }
            window.render();
        });

        window.ui('auth-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = window.ui('auth-btn');
            const originalText = btn.innerText;
            btn.innerText = "AUTHORIZING...";
            try {
                const email = window.ui('auth-email').value;
                const pass = window.ui('auth-password').value;
                if(state.isSignUp) await createUserWithEmailAndPassword(auth, email, pass);
                else await signInWithEmailAndPassword(auth, email, pass);
            } catch(e) { 
                const errEl = window.ui('auth-error');
                if(errEl) { errEl.innerText = "Access Denied: " + e.message.replace('Firebase:', ''); errEl.classList.remove('hidden'); }
                btn.innerText = originalText;
            }
        });

        window.render();
    </script>
</body>
</html>
